#!/bin/bash
echo -e "+-------------------+\n| RUNNING ALL TESTS |\n+-------------------+"

#Run tests on MIPS_Simulator
#1. Open directory of TESTS X
#2. For each test, take RETCODE X
#3. Store retcode into CSV X
#4. Get extra information by matching .txt with .bin 

	#any temp files to be stored in test/temp
	#output of testbench created in test/output. i.e per test logfiles
	#once all tests run, print CSV file to stdout, with each row corresponding to one execution of Simulator under test.

printf "TEST,RETCODE\n" >> test/output/log.csv

for file in test/input/*.bin
do
	name=${file##*/}
	./bin/mips_simulator test/input/${name}
	RETCODE=$?
	NUMTESTS=0
	COUNT=0

	#printf "Host\tDate\tOperation\tDuration\n" >> log.csv
	#printf "$host\t$(date)\tTime Taken to checkout\t$Time_checkout\n" >> log.csv
	printf  "${name},${RETCODE}\n" >> test/output/log.csv
	echo "[INFO] Testing: ${name}"
	filename="${file%.*}.s"
	head -1 $filename |
	while read -r line;  do
		# reading each line
		#echo "$line"
		n=0
		values=$(echo $line | tr ";" "\n")
		for value in $values
		do
			if (($n == 2))
			then
				echo -e "[INFO] Expected: ${value}\n[INFO] Returned: ${RETCODE}"
				if ((${value} == ${RETCODE}))
				then
					echo "-> PASS"
					printf "Pass,">> test/output/testing.csv
				else
					echo "-> FAIL"
					printf "Fail,">> test/output/testing.csv
				fi
			else
				printf "$value,">> test/output/testing.csv
			fi
			n=$((n+1))
		done
		printf "\n">> test/output/testing.csv
	done
done

echo "$COUNT/$NUMTESTS test cases passed."
echo -e "+--------------------+\n| ALL TESTS COMPLETE |\n+--------------------+"
