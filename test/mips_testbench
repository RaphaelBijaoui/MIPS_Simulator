#!/bin/bash
echo -e "+-------------------+\n| RUNNING ALL TESTS |\n+-------------------+"

	#any temp files to be stored in test/temp
	#output of testbench created in test/output. i.e per test logfiles
	#once all tests run, print CSV file to stdout, with each row corresponding to one execution of Simulator under test.

printf "TEST,RETCODE\n" >> test/output/log.csv

for file in test/input/*.bin
do
	name=${file##*/}	

	filename="${file%.*}.s"
	sfilename="test/input/ADD-wrap.mips.s"

	values=()

	#Read file values
	while IFS= read -r line || [[ -n "$line" ]]; do
		# reading each line
		value="${line//#}"
		values+=("$value")
	done < $filename

	no_path_filename=$(basename -- "$file")
	test_id="${no_path_filename%.mips.bin}"
	operation=${values[0]}
	sim_code=${values[1]}
	user_id=${values[2]}
	comments=${values[3]}
	getc=${values[4]}
	expected_putc=${values[5]}
	
	#Run test
	./bin/mips_simulator test/input/${name}

	RETCODE=$?

	if [ $RETCODE -ge 128 ]; then
		RETCODE=$((RETCODE-256))
	fi

	NUMTESTS=0
	COUNT=0

	printf  "${name},${RETCODE}\n" >> test/output/log.csv
	echo "[INFO] Testing: ${name}"

	echo -e "[INFO] Expected: ${sim_code}\n[INFO] Returned: ${RETCODE}"
	if ((${sim_code} == ${RETCODE}))
	then
		echo "Pass"
		printf "${test_id},${operation},Pass,${user_id},${comments},${sim_code},${RETCODE}\n">> test/output/testing.csv
	else
		echo "Fail"
		printf "${test_id},${operation},Fail,${user_id},${comments},${sim_code},${RETCODE}\n">> test/output/testing.csv
	fi
done

echo "$COUNT/$NUMTESTS test cases passed."
echo -e "+--------------------+\n| ALL TESTS COMPLETE |\n+--------------------+"